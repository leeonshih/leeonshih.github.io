---
layout: post
title:  Cyusb3014 Slavefifo 调试
date:   2015-06-26
categories: Hardware
tags: USB3.0 Hardware
---
<!--more-->
### Usb Starter板测试无反应
**2015-06-05**
    
在usb starter板子上测试了bulk source sink，测试了速率，接下来就计划测试slavefifo接口。整理了一下FPGA-xc6-v4板子的接口，发现排线上刚好有42条IO口，刚好够连接USB3.0 slavefifo接口的最少信号数量（汗！！），做了一个转接板，通过FPC将 USB3.0 starter跟xc6-v4两个板子连到一起，然后看AN65974，看AN65974配套的代码和固件。

第一步，在大致清楚slavefifo的接口时序后，在xc6slx16中直接给rd，wr，cs，add，oe固定的信号，然后通过PC端control center往usb3.0写入输入，检查slavefifo接口的flag，结果发现flag状态怎么着都不对，仔细检查了线序，ucf文件，没有找到问题。怀疑是测试方法不对。

第二步，直接将AN65974文档中对应的fpga逻辑代码一直到我的板子上，对slavefifo接口进行操作，也是一点反应都没有。fpga端flag不对，pc端读写数据都没有反应。仔细检查了可能出错地方，没有头绪。

### Huanor USB开发板
**2015-06-07**

跟网友和卖家都沟通了一下，没有得到有意义的建议。怀疑是usb starter板子有问题，于是在网上重新下单购买了Huanor的USB3.0+ep3c16的开发板。

### Slavefifo工作正常
**2015-06-25**

用huanor的板子测试了huanor自带的例程，slavefifo工作正常。
    
我重新写了slavefifo接口的控制逻辑，测试了huanor的例程和AN65974我修改过的例程，全都工作OK。

将这两个例程放到usb starter板子上，flag标志还是不对，再次检查了线序和fpga信号输出之后，开始仔细看usb starter板子，检查信号。结果发现fpga给的pclk信号没有到3014端，再检查原理图和板子，发现板子上pclk信号上串的22欧姆电阻焊接了一个10K的。太坑爹了。（也怪自己最近做事没精神，不然2015-06-07就应该检查出来了）。

更换电阻后，flag标识有反映了。然后将ep3c16上已经测试过的逻辑都挪到xc6slx16上，反复倒腾了几次，测试通了。

### Slavefifo丢数据

**2015-06-26**

已经调试好的逻辑在3014+ep3c16上运行良好，但是在xc6-v4板子上问题很多，读的用flagb，写得用flaga，不然就读写不能操作。在3014+ep3c16上不会丢数，在xc6-v4上就会丢数据。一模一样的逻辑，死活倒腾了很久。

通过反复对比测试，找到一些规律，发现xc6上写好像比ep3c16上快1个周期，正好是这快的一个周期，恰好可以解释，wr操作得用flaga，因为wr快了一个周期，就不能把flagb写满，所以就卡住了，在xc6上增加了一个clk的操作延时，发现flag状态也跟ep3c16一致了，但是还是会丢数据。

这个时候开始怀疑是时钟域问题，将xc6的时钟改为了pll输出，最开始用的是50M时钟，没有过PLL（汗）。完成之后再调整了一下读写的时序，然后在xc6上，slavefifo接口操作完全正常了，数据也不会丢失了。

### 1MB的包会传输失败

**2015-07-01**
在前面工作的基础上，继续测试包传输。长包和短包，在测试的过程中，碰到一个问题，就是如果包大小是1MB，在control center中设置大于1MB的接收数据，就会出错，传输失败，如果fpga发送包为（1M-2）B，就不会有这个问题。

怀疑是不是包大小不能大于1MB，但是一想有没有逻辑，因为如果不用pktend信号的时候，是持续传输的，那可以理解为无限大的包。后来又将包设置为2MB，和7，几MB，然后按照1MB大小，2MB大小来接收，都没有问题。

所以这个问题暂时就没管了，反正只要不发送刚好1MB的包就没问题。


### 短包大小不能设置为16KB整数倍
**2015-08-21**

接上次的测试结果，今天在测试过程中，发现，如果短包的大小刚好是buffer的整倍数，则上位机无法正确划分短包，可能是因为在buffer的最后一个字节，usb3.0自动就进入buffer切换和分包的装套了，所以pktend自然就被忽略了。
这次的测试是，下边写入16KB大小的短包，结果上位机接收时不会按照16KB接收，而是设置多大的接收，就会接收到多少数据，如果将包大小改为非16KB，上位机收包自动又能看到正确大小的包了。


### 理解flag时序，问题解决
**2016**

整个USB3.0 传输预览视频图像功能已经完全跑通，回过头来继续查看整理前期的逻辑设计。找到一个bug，就是对CYUSB3014 flaga， flagb 两个时序没有正确理解，flagab两个信号有延迟，因此CYUSB3014设计的flaga，flagb不会直接标志空满，而会标志空满的提前量，在连续写入fifo和单周期写入fifo的时候，对flag信号的判断就会不一样。基于这个原因，从新修改了flag状态标志的判断逻辑，1MB包不能收到pakage end， 16KB包整数倍短包接收错误的bug都得到了解决。
