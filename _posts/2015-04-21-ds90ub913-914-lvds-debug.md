---
layout: post
title:  Lvds(ds90ub913/914)调试
date:   2015-04-21 
categories: Hardware
tags: Hardware
---

## Lvds不通
**2014-12-09**

连接lvds板，基本都是780hz的窄脉冲       
913的寄存器0x0c 大部分时间是0x24，偶尔会有0x25，然后又间断的clk
914通过I2C无法访问。

在lvds信号中间桥接100R电阻    
0x0c = 0x37，有连续的时钟和lock信号，但是时钟是25M，与输入端48M不一致
0x0c = 0x26   
状态不稳定，偶尔有25M，偶尔有48M时钟。   

## 913-914无需外部100R
**2014-12-09**

测试3个板子，症状都一样，有俩版i2c还不能操作，应该是没有正常启动

仔细翻阅寄存器，测试到0x35寄存器，bit3，bit2都是0，不能正确反映mode状态。尝试些0x35寄存器，操作也不太正常，没继续。

将ov7725板子的xclk（24M）飞到pclk输出（48M）管脚，用晶振的24M取代pclk给到913，结果发现0x35寄存器正常了，bit2为1，914端lock信号也正常了，并且有24M时钟输出。但是没有HS，VS，Data信号全是低电平。

## 913-914时断时序且IIC有问题
**2014-12-10 12:32:17**

目前配置的工作模式是12bit low，担心是不是48M的pclk会超出范围，造成芯片工作不稳定，因为12bit low 模式pclk最高只支持50Mhz，于是将OV7725的24M晶振换为20M，pclk速出由48M变为40M。

掉电后立刻再上电，914就会输出25M的标准时钟，而且上电即刻有时钟输出。如果是掉电后二三十秒之后再上电，pclk就是高电平，需要7,8秒钟的时间之后，就会输出正常的40M时钟（pclk）。

确认了PDB.OEN等信号应该是接到3.3V,而不是1.8V，飞线改了电路之后，上电即刻看到断断续续的40M时钟（pclk）。
现在外部电压全都正常了，还是不能持续lock，开始怀疑是pclk摆幅低造成的，用晶振的20M输出替换pclk，板子完全正常工作。
两个芯片都可以通过I2C正常访问了。

从这里的结果可以判断，最开始913,914各种怪异状态，应该是管脚拉高用的1.8V而不是3.3V，造成各个芯片每次上电都捕捉到不同的状态，一会是PDB，一会BIST，一会正常工作。

将914的mode配置为10bit high speed，12bit high speed之后，I2C访问914又出错了。不是mode的问题，改为默认mode，也不能访问。不知道哪个管脚又出错了。


## 913-914调通但不能稳定LOCK
**2015-04-21  21:28:59**

前段时间lvds已经调通了，但是还有bug，就是有一两款sensor总是不能稳定lock。lock信号以几微秒到几十微秒的周期跳变，914端pclk输出也时断时续。这个问题当时没细调，当时观察以为不稳定的sensor可能是pclk幅度比较小造成的。

4月中旬开始调试PO3100sensor，这个sensor的pclk输出波形幅度很大，但是也时断时通。后来实在没有头绪，又找NT99141的sensor测试，也是类似的现象，在盲目的乱试了两天之后，终于发现，用PO3100的时候，pclk越快，lock不住的程度越厉害，pclk越慢，lock越稳定，当pclk低到30多M的时候，就能稳定输出。这个时候，现象就比较明显了，认定问题是sensor的pclk输出抖动和漂移比较大，超出了913正常工作的范围。但是sensor工作都是固定的，让人头大。继续研究PO3100的配置工具，发现pll是可配置的，并且pclk可以分频输出，这就理想了，把PO3100的内部工作时钟倍频增加2倍，pclk 2分频，这样的话提高了内部工作频率，输出的各个时钟信号又保持不变，结果发现lock明显稳定一些，在把PO3100倍频增加4倍，pclk4分频输出，这个时候，913-913稳定lock并持续输出sensor的信号。

后来又测试了一下，在sensor输出720P（pclk=74.25M）的时候，913-914配置为12bit highspeed也会有明显的lock不稳定状态，看来是离临界状态太近了，调整为10bit mode之后，稳定lock输出，工作状态稳定。


## 结论1

913有了时钟启动之后，914,913会相互通信，交换片子的信息，比如双方的I2C地址，**914的mode选择也会被设置到913芯片里，可以在913的0x05寄存器查到**。
I2C查看寄存器，**比较奇怪的是913的0x35寄存器，并不能显示913mode脚的状态，也可能0x35是设置寄存器，而不是状态寄存器，是用来配置而不是查看的**。

## 结论2

913,914 lvds芯片已经调试完成，并且测试了 pc1089摄像头>>>>913>>>>lvds>>>>914>>>>imx6>>>>hdmi显示。证明913,914完全可用。913,914支持的频率最高可到100M，也能适应大多数的摄像头。

但是有个问题，因为913要将时钟信号倍频到1G多的速率，因此对sensor的pclk输出信号质量有要求。在测试过程中，ov7725的48Mpclk信号，摆幅在900mv-1900mv左右，就不能持续lock住，914恢复的摄像头数据就时断时续。pc1089的信号幅度在800mv-2000mv左右，就能正常稳定的工作。

这个问题已经研究清楚了，lock不稳定跟摆幅没关系，主要是sensor的pclk输出抖动和漂移太大，导致913不能稳定倍频并工作。如果有sensor是这种情况，只能通过修改pll参数，提高sensor内部的工作频率，再分频输出pclk，以此来提高pclk的时钟信号质量，从而使得913-914稳定工作。

